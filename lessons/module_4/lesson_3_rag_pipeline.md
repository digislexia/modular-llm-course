# –£—Ä–æ–∫ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

## –í–≤–µ–¥–µ–Ω–∏–µ

–í –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É—Ä–æ–∫–∞—Ö –º—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –¥–≤–µ —á–∞—Å—Ç–∏ RAG-—Å–∏—Å—Ç–µ–º—ã:
- **–£—Ä–æ–∫ 1**: –ü–æ–Ω—è–ª–∏, –∑–∞—á–µ–º –Ω—É–∂–µ–Ω RAG –∏ –∫–∞–∫ –æ–Ω —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
- **–£—Ä–æ–∫ 2**: –°–æ–∑–¥–∞–ª–∏ Retriever ‚Äî —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Å–º—ã—Å–ª—É

–¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è **—Å–æ–µ–¥–∏–Ω–∏—Ç—å –≤—Å—ë –≤–º–µ—Å—Ç–µ**! –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π RAG pipeline, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ.

–ö –∫–æ–Ω—Ü—É —É—Ä–æ–∫–∞ —É –≤–∞—Å –±—É–¥–µ—Ç **—Ä–∞–±–æ—Ç–∞—é—â–∏–π QA-–±–æ—Ç**, —Å–ø–æ—Å–æ–±–Ω—ã–π –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≤–∞—à–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.

## –¶–µ–ª–∏ —É—Ä–æ–∫–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ:

- ‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è RAG
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π RAG pipeline end-to-end
- ‚úÖ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ QA-–±–æ—Ç–∞
- ‚úÖ –£–ª—É—á—à–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –û—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ RAG-—Å–∏—Å—Ç–µ–º—ã

## –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã

- **RAG Pipeline** ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –≤–æ–ø—Ä–æ—Å–∞ –¥–æ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ retrieval –∏ generation
- **Context Window** ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º —Ç–µ–∫—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å LLM
- **Grounding** ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
- **Faithfulness** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- **Hallucination detection** ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –≤—ã–¥—É–º–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

## 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è RAG

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ RAG-–ø—Ä–æ–º–ø—Ç–∞

–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π RAG-–ø—Ä–æ–º–ø—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä—ë—Ö —á–∞—Å—Ç–µ–π:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢                ‚îÇ
‚îÇ  ‚Ä¢ –†–æ–ª—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞                      ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞      ‚îÇ
‚îÇ  ‚Ä¢ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         –ö–û–ù–¢–ï–ö–°–¢ (–¥–æ–∫—É–º–µ–Ω—Ç—ã)            ‚îÇ
‚îÇ  ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç 1                           ‚îÇ
‚îÇ  ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç 2                           ‚îÇ
‚îÇ  ‚Ä¢ ...                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø             ‚îÇ
‚îÇ  ‚Ä¢ –ß—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤

```python
"""
–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º—ã.
"""

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ë–ê–ó–û–í–´–ô RAG –ü–†–û–ú–ü–¢
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RAG_SYSTEM_PROMPT_BASIC = """–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã 
–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∏–∂–µ
2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –¶–∏—Ç–∏—Ä—É–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
4. –û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É"""


def create_rag_prompt_basic(question: str, documents: list) -> str:
    """–°–æ–∑–¥–∞—ë—Ç –±–∞–∑–æ–≤—ã–π RAG –ø—Ä–æ–º–ø—Ç"""
    
    context = "\n\n".join([
        f"[–î–æ–∫—É–º–µ–Ω—Ç {i+1}]\n{doc}" 
        for i, doc in enumerate(documents)
    ])
    
    return f"""–ö–û–ù–¢–ï–ö–°–¢:
{context}

–í–û–ü–†–û–°: {question}

–û–¢–í–ï–¢ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤—ã—à–µ):"""


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–†–û–î–í–ò–ù–£–¢–´–ô RAG –ü–†–û–ú–ü–¢ –° –¶–ò–¢–ò–†–û–í–ê–ù–ò–ï–ú
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RAG_SYSTEM_PROMPT_ADVANCED = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã,
—Å—Ç—Ä–æ–≥–æ –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. –ö–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–∫—Ä–µ–ø–ª—è–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ [–î–æ–∫—É–º–µ–Ω—Ç N]
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —É–∫–∞–∂–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
4. –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É ‚Äî —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ
5. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- –ù–∞—á–Ω–∏ —Å –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
- –î–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–∏ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –í –∫–æ–Ω—Ü–µ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏–ª–∏ –≤—ã–≤–æ–¥

–ï–°–õ–ò –û–¢–í–ï–¢–ê –ù–ï–¢:
–°–∫–∞–∂–∏: "–í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É."
–∏ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç."""


def create_rag_prompt_advanced(
    question: str, 
    documents: list,
    metadata: list = None
) -> str:
    """–°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π RAG –ø—Ä–æ–º–ø—Ç —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""
    
    context_parts = []
    for i, doc in enumerate(documents):
        header = f"[–î–æ–∫—É–º–µ–Ω—Ç {i+1}]"
        if metadata and i < len(metadata):
            source = metadata[i].get('source', 'Unknown')
            header += f" (–ò—Å—Ç–æ—á–Ω–∏–∫: {source})"
        context_parts.append(f"{header}\n{doc}")
    
    context = "\n\n---\n\n".join(context_parts)
    
    return f"""–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:

{context}

---

–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {question}

–û–¢–í–ï–¢ (—Å —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤):"""


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–†–û–ú–ü–¢ –î–õ–Ø –°–õ–£–ß–ê–ï–í –ë–ï–ó –û–¢–í–ï–¢–ê
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RAG_SYSTEM_PROMPT_WITH_FALLBACK = """–¢—ã ‚Äî —á–µ—Å—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û 
–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –ù–ï–¢ –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è
- –õ—É—á—à–µ —Å–∫–∞–∑–∞—Ç—å "–Ω–µ –∑–Ω–∞—é", —á–µ–º –¥–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç

–û—Ü–µ–Ω–∏ —Å–≤–æ—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:
- –í–´–°–û–ö–ê–Ø: –æ—Ç–≤–µ—Ç —è–≤–Ω–æ –µ—Å—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- –°–†–ï–î–ù–Ø–Ø: –æ—Ç–≤–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å, —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
- –ù–ò–ó–ö–ê–Ø: –æ—Ç–≤–µ—Ç –∫–æ—Å–≤–µ–Ω–Ω–æ —Å–≤—è–∑–∞–Ω —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
- –ù–ï–¢ –û–¢–í–ï–¢–ê: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"""


def create_rag_prompt_with_confidence(question: str, documents: list) -> str:
    """–ü—Ä–æ–º–ø—Ç —Å –æ—Ü–µ–Ω–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    
    context = "\n\n".join([
        f"[–î–æ–∫—É–º–µ–Ω—Ç {i+1}]\n{doc}" 
        for i, doc in enumerate(documents)
    ])
    
    return f"""–î–û–ö–£–ú–ï–ù–¢–´:
{context}

–í–û–ü–†–û–°: {question}

–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–£–í–ï–†–ï–ù–ù–û–°–¢–¨: [–í–´–°–û–ö–ê–Ø/–°–†–ï–î–ù–Ø–Ø/–ù–ò–ó–ö–ê–Ø/–ù–ï–¢ –û–¢–í–ï–¢–ê]
–û–¢–í–ï–¢: [—Ç–≤–æ–π –æ—Ç–≤–µ—Ç]
–ò–°–¢–û–ß–ù–ò–ö–ò: [–Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤]"""
```

### üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è

–ö–∞–∫–æ–π –ø—Ä–æ–º–ø—Ç –ª—É—á—à–µ –ø–æ–¥–æ–π–¥—ë—Ç –¥–ª—è:
1. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏?
2. –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞?
3. –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞?

<details>
<summary>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</summary>

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç —Å —á—ë—Ç–∫–∏–º fallback ("–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É")
2. **–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
3. **–Æ—Ä–∏—Å—Ç**: –° –æ—Ü–µ–Ω–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–µ –¥–∞–≤–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤
</details>

## 2. –°–æ–∑–¥–∞–Ω–∏–µ RAG Pipeline

–¢–µ–ø–µ—Ä—å —Å–æ–±–µ—Ä—ë–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –µ–¥–∏–Ω—ã–π –∫–ª–∞—Å—Å:

```python
"""
–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π RAG Pipeline ‚Äî –æ—Ç –≤–æ–ø—Ä–æ—Å–∞ –¥–æ –æ—Ç–≤–µ—Ç–∞.
"""

import os
import requests
import numpy as np
from typing import List, Dict, Optional, Tuple
from dataclasses import dataclass
from dotenv import load_dotenv

load_dotenv()


@dataclass
class RAGResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç RAG-–∑–∞–ø—Ä–æ—Å–∞"""
    answer: str
    sources: List[Dict]
    confidence: str
    tokens_used: int


class RAGPipeline:
    """
    –ü–æ–ª–Ω—ã–π RAG pipeline: –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ‚Üí –ø–æ–∏—Å–∫ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
    """
    
    def __init__(
        self,
        embedding_model: str = "text-embedding-3-small",
        llm_model: str = "openai/gpt-3.5-turbo",
        vector_dimension: int = 1536,
        chunk_size: int = 500,
        chunk_overlap: int = 50
    ):
        """
        Args:
            embedding_model: –ú–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
            llm_model: –ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
            vector_dimension: –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
            chunk_size: –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
            chunk_overlap: –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
        """
        self.embedding_model = embedding_model
        self.llm_model = llm_model
        self.chunk_size = chunk_size
        self.chunk_overlap = chunk_overlap
        
        # API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        self.api_key = os.getenv("OPENROUTER_API_KEY") or os.getenv("OPENAI_API_KEY")
        self.embeddings_url = "https://api.openai.com/v1/embeddings"
        self.chat_url = "https://openrouter.ai/api/v1/chat/completions"
        
        # –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º FAISS)
        import faiss
        self.index = faiss.IndexFlatIP(vector_dimension)
        self.documents: List[str] = []
        self.metadata: List[Dict] = []
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_queries": 0,
            "total_tokens": 0,
            "avg_retrieval_score": 0
        }
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # CHUNKING
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _chunk_text(self, text: str, source: str = "unknown") -> List[Dict]:
        """–†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""
        chunks = []
        start = 0
        chunk_idx = 0
        
        while start < len(text):
            end = start + self.chunk_size
            chunk = text[start:end]
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–∫–æ–Ω—á–∏—Ç—å –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            if end < len(text):
                for sep in ['. ', '.\n', '\n\n', '\n']:
                    last_sep = chunk.rfind(sep)
                    if last_sep > self.chunk_size // 2:
                        chunk = text[start:start + last_sep + len(sep)]
                        end = start + last_sep + len(sep)
                        break
            
            chunks.append({
                "text": chunk.strip(),
                "metadata": {
                    "source": source,
                    "chunk_index": chunk_idx,
                    "char_start": start,
                    "char_end": end
                }
            })
            
            start = end - self.chunk_overlap
            chunk_idx += 1
        
        return [c for c in chunks if c["text"]]
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # EMBEDDINGS
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _get_embeddings(self, texts: List[str]) -> np.ndarray:
        """–ü–æ–ª—É—á–∞–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤"""
        response = requests.post(
            self.embeddings_url,
            headers={
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            },
            json={
                "model": self.embedding_model,
                "input": texts
            }
        )
        
        if response.status_code != 200:
            raise Exception(f"Embedding API Error: {response.text}")
        
        data = response.json()
        embeddings = [item["embedding"] for item in data["data"]]
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–ª—è –∫–æ—Å–∏–Ω—É—Å–Ω–æ–≥–æ —Å—Ö–æ–¥—Å—Ç–≤–∞
        embeddings = np.array(embeddings, dtype=np.float32)
        norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
        return embeddings / norms
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # INDEXING
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def add_documents(
        self, 
        documents: List[str], 
        sources: List[str] = None
    ):
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.
        
        Args:
            documents: –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            sources: –ù–∞–∑–≤–∞–Ω–∏—è/–ø—É—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        """
        if sources is None:
            sources = [f"doc_{i}" for i in range(len(documents))]
        
        print(f"üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ {len(documents)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...")
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞–Ω–∫–∏
        all_chunks = []
        for doc, source in zip(documents, sources):
            chunks = self._chunk_text(doc, source)
            all_chunks.extend(chunks)
        
        print(f"‚úÇÔ∏è –°–æ–∑–¥–∞–Ω–æ {len(all_chunks)} —á–∞–Ω–∫–æ–≤")
        
        # –ü–æ–ª—É—á–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –±–∞—Ç—á–∞–º–∏
        batch_size = 100
        all_embeddings = []
        
        for i in range(0, len(all_chunks), batch_size):
            batch = all_chunks[i:i + batch_size]
            texts = [c["text"] for c in batch]
            embeddings = self._get_embeddings(texts)
            all_embeddings.append(embeddings)
            print(f"  –≠–º–±–µ–¥–¥–∏–Ω–≥–∏: {min(i + batch_size, len(all_chunks))}/{len(all_chunks)}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–¥–µ–∫—Å
        all_embeddings = np.vstack(all_embeddings)
        self.index.add(all_embeddings)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        for chunk in all_chunks:
            self.documents.append(chunk["text"])
            self.metadata.append(chunk["metadata"])
        
        print(f"‚úÖ –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ {len(self.documents)} —á–∞–Ω–∫–æ–≤")
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # RETRIEVAL
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def retrieve(
        self, 
        query: str, 
        top_k: int = 5,
        threshold: float = 0.0
    ) -> List[Dict]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
        
        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π score (0-1)
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
        """
        if self.index.ntotal == 0:
            return []
        
        # –≠–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞
        query_emb = self._get_embeddings([query])
        
        # –ü–æ–∏—Å–∫
        scores, indices = self.index.search(query_emb, min(top_k, self.index.ntotal))
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        results = []
        for score, idx in zip(scores[0], indices[0]):
            if idx < 0 or score < threshold:
                continue
            results.append({
                "text": self.documents[idx],
                "score": float(score),
                "metadata": self.metadata[idx]
            })
        
        return results
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # GENERATION
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _generate_answer(
        self, 
        question: str, 
        context_docs: List[Dict],
        system_prompt: str = None
    ) -> Tuple[str, int]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
        
        Returns:
            Tuple[–æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Ç–æ–∫–µ–Ω–æ–≤]
        """
        if system_prompt is None:
            system_prompt = """–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã 
–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –¶–∏—Ç–∏—Ä—É–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ [–î–æ–∫—É–º–µ–Ω—Ç N]
4. –û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context_parts = []
        for i, doc in enumerate(context_docs):
            source = doc.get("metadata", {}).get("source", "Unknown")
            score = doc.get("score", 0)
            context_parts.append(
                f"[–î–æ–∫—É–º–µ–Ω—Ç {i+1}] (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score:.2f}, –∏—Å—Ç–æ—á–Ω–∏–∫: {source})\n{doc['text']}"
            )
        
        context = "\n\n---\n\n".join(context_parts)
        
        user_prompt = f"""–ö–û–ù–¢–ï–ö–°–¢:
{context}

–í–û–ü–†–û–°: {question}

–û–¢–í–ï–¢:"""
        
        # –ó–∞–ø—Ä–æ—Å –∫ LLM
        response = requests.post(
            self.chat_url,
            headers={
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            },
            json={
                "model": self.llm_model,
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                "max_tokens": 1000,
                "temperature": 0.3  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
            }
        )
        
        if response.status_code != 200:
            raise Exception(f"LLM API Error: {response.text}")
        
        data = response.json()
        answer = data["choices"][0]["message"]["content"]
        tokens = data.get("usage", {}).get("total_tokens", 0)
        
        return answer, tokens
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # MAIN QUERY METHOD
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def query(
        self, 
        question: str,
        top_k: int = 5,
        threshold: float = 0.5
    ) -> RAGResult:
        """
        –ü–æ–ª–Ω—ã–π RAG pipeline: –ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
            
        Returns:
            RAGResult —Å –æ—Ç–≤–µ—Ç–æ–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
        """
        self.stats["total_queries"] += 1
        
        # 1. Retrieval
        retrieved_docs = self.retrieve(question, top_k, threshold)
        
        if not retrieved_docs:
            return RAGResult(
                answer="–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å.",
                sources=[],
                confidence="–ù–ï–¢ –î–ê–ù–ù–´–•",
                tokens_used=0
            )
        
        # –°—Ä–µ–¥–Ω–∏–π score –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        avg_score = sum(d["score"] for d in retrieved_docs) / len(retrieved_docs)
        self.stats["avg_retrieval_score"] = (
            self.stats["avg_retrieval_score"] * (self.stats["total_queries"] - 1) + avg_score
        ) / self.stats["total_queries"]
        
        # 2. Generation
        answer, tokens = self._generate_answer(question, retrieved_docs)
        self.stats["total_tokens"] += tokens
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        if avg_score > 0.8:
            confidence = "–í–´–°–û–ö–ê–Ø"
        elif avg_score > 0.6:
            confidence = "–°–†–ï–î–ù–Ø–Ø"
        else:
            confidence = "–ù–ò–ó–ö–ê–Ø"
        
        return RAGResult(
            answer=answer,
            sources=retrieved_docs,
            confidence=confidence,
            tokens_used=tokens
        )
    
    def get_stats(self) -> Dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
        return self.stats.copy()


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if __name__ == "__main__":
    print("="*70)
    print("RAG PIPELINE ‚Äî –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø")
    print("="*70)
    
    # –°–æ–∑–¥–∞—ë–º pipeline
    rag = RAGPipeline()
    
    # –ü—Ä–∏–º–µ—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    documents = [
        """Python ‚Äî –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.
        –°–æ–∑–¥–∞–Ω –ì–≤–∏–¥–æ –≤–∞–Ω –†–æ—Å—Å—É–º–æ–º –≤ 1991 –≥–æ–¥—É. Python –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ
        –ø–∞—Ä–∞–¥–∏–≥–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é,
        –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é. –û—Å–Ω–æ–≤–Ω—ã–µ —á–µ—Ä—Ç—ã: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ
        —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é, –±–æ–ª—å—à–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞.""",
        
        """–°–ø–∏—Å–∫–∏ –≤ Python ‚Äî —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω—è–µ–º—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –°–æ–∑–¥–∞—é—Ç—Å—è
        –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏: [1, 2, 3]. –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã: append() –¥–æ–±–∞–≤–ª—è–µ—Ç
        —ç–ª–µ–º–µ–Ω—Ç, remove() —É–¥–∞–ª—è–µ—Ç, sort() —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Å—Ä–µ–∑—ã:
        list[1:3] –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∏–Ω–¥–µ–∫—Å–∞ 1 –ø–æ 2.""",
        
        """–°–ª–æ–≤–∞—Ä–∏ (dict) –≤ Python —Ö—Ä–∞–Ω—è—Ç –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ. –°–æ–∑–¥–∞—é—Ç—Å—è
        —Ñ–∏–≥—É—Ä–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏: {'name': 'Alice', 'age': 30}. –ö–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
        –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º–∏ (—Å—Ç—Ä–æ–∫–∏, —á–∏—Å–ª–∞, –∫–æ—Ä—Ç–µ–∂–∏). –ú–µ—Ç–æ–¥—ã: keys(), values(),
        items(), get() –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.""",
        
        """–§—É–Ω–∫—Ü–∏–∏ –≤ Python –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ def. –ü—Ä–∏–º–µ—Ä:
        def greet(name): return f'Hello, {name}'. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, *args –∏ **kwargs. Lambda-—Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
        lambda x: x * 2.""",
        
        """–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (ML) ‚Äî —Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞,
        –≥–¥–µ —Å–∏—Å—Ç–µ–º—ã –æ–±—É—á–∞—é—Ç—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö. –¢–∏–ø—ã: supervised (—Å —É—á–∏—Ç–µ–ª–µ–º),
        unsupervised (–±–µ–∑ —É—á–∏—Ç–µ–ª—è), reinforcement (—Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º).
        –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: scikit-learn, TensorFlow, PyTorch.""",
    ]
    
    sources = ["python_intro.txt", "python_lists.txt", "python_dicts.txt",
               "python_functions.txt", "ml_basics.txt"]
    
    # –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º
    rag.add_documents(documents, sources)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    print("\n" + "="*70)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–†–û–°–û–í")
    print("="*70)
    
    questions = [
        "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤ Python?",
        "–ö—Ç–æ —Å–æ–∑–¥–∞–ª Python –∏ –∫–æ–≥–¥–∞?",
        "–ö–∞–∫–∏–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç?",
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–æ–∫—á–µ–π–Ω?",  # –ù–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
    ]
    
    for q in questions:
        print(f"\n{'‚îÄ'*70}")
        print(f"‚ùì –í–û–ü–†–û–°: {q}")
        print('‚îÄ'*70)
        
        result = rag.query(q, top_k=3, threshold=0.4)
        
        print(f"\nüí¨ –û–¢–í–ï–¢:\n{result.answer}")
        print(f"\nüìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result.confidence}")
        print(f"üìÑ –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {len(result.sources)}")
        
        if result.sources:
            print("\nüìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:")
            for i, src in enumerate(result.sources, 1):
                print(f"   {i}. [{src['score']:.2f}] {src['metadata']['source']}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print(f"\n{'='*70}")
    print(f"üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê: {rag.get_stats()}")
```

## 3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: QA-–±–æ—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–°–æ–∑–¥–∞–¥–∏–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ QA-–±–æ—Ç–∞:

```python
"""
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA-–±–æ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ RAG.
"""

import os
from pathlib import Path
from rag_pipeline import RAGPipeline, RAGResult


class QABot:
    """
    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π QA-–±–æ—Ç —Å RAG.
    """
    
    def __init__(self, name: str = "RAG Bot"):
        self.name = name
        self.rag = RAGPipeline()
        self.conversation_history = []
    
    def load_documents_from_file(self, filepath: str):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ñ–∞–π–ª–∞ (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ---)"""
        path = Path(filepath)
        if not path.exists():
            raise FileNotFoundError(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {filepath}")
        
        with open(path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—é
        docs = [d.strip() for d in content.split('---') if d.strip()]
        
        # –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #
        docs = [d for d in docs if not d.startswith('#')]
        
        sources = [f"{path.stem}_part_{i+1}" for i in range(len(docs))]
        
        self.rag.add_documents(docs, sources)
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(docs)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ {filepath}")
    
    def load_documents_from_directory(self, directory: str, extension: str = ".txt"):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"""
        path = Path(directory)
        if not path.exists():
            raise FileNotFoundError(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {directory}")
        
        docs = []
        sources = []
        
        for file in path.glob(f"*{extension}"):
            with open(file, 'r', encoding='utf-8') as f:
                content = f.read()
            docs.append(content)
            sources.append(file.name)
        
        if docs:
            self.rag.add_documents(docs, sources)
            print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(docs)} —Ñ–∞–π–ª–æ–≤ –∏–∑ {directory}")
        else:
            print(f"‚ö†Ô∏è –§–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º {extension} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ {directory}")
    
    def ask(self, question: str) -> RAGResult:
        """–ó–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç"""
        result = self.rag.query(question, top_k=5, threshold=0.4)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.conversation_history.append({
            "question": question,
            "answer": result.answer,
            "confidence": result.confidence
        })
        
        return result
    
    def format_answer(self, result: RAGResult) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞"""
        output = []
        output.append(f"\nüí¨ {self.name}:")
        output.append(result.answer)
        output.append(f"\nüìä –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result.confidence}")
        
        if result.sources:
            output.append("\nüìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:")
            for i, src in enumerate(result.sources[:3], 1):
                score_bar = "‚ñà" * int(src['score'] * 10) + "‚ñë" * (10 - int(src['score'] * 10))
                output.append(f"   {i}. [{score_bar}] {src['metadata']['source']}")
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞
                preview = src['text'][:100].replace('\n', ' ')
                output.append(f"      \"{preview}...\"")
        
        return "\n".join(output)
    
    def run_interactive(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("\n" + "="*70)
        print(f"ü§ñ {self.name} –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        print("="*70)
        print("–ö–æ–º–∞–Ω–¥—ã:")
        print("  ‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞")
        print("  ‚Ä¢ '–∏—Å—Ç–æ—Ä–∏—è' ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞")
        print("  ‚Ä¢ '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
        print("  ‚Ä¢ '–≤—ã—Ö–æ–¥' ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É")
        print("="*70)
        
        while True:
            try:
                user_input = input("\n‚ùì –í—ã: ").strip()
                
                if not user_input:
                    continue
                
                if user_input.lower() in ['–≤—ã—Ö–æ–¥', 'exit', 'quit', 'q']:
                    print(f"\nüëã {self.name}: –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break
                
                if user_input.lower() == '–∏—Å—Ç–æ—Ä–∏—è':
                    self._show_history()
                    continue
                
                if user_input.lower() in ['—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'stats']:
                    self._show_stats()
                    continue
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
                result = self.ask(user_input)
                print(self.format_answer(result))
                
            except KeyboardInterrupt:
                print(f"\n\nüëã {self.name}: –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
            except Exception as e:
                print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
    
    def _show_history(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"""
        if not self.conversation_history:
            print("\nüìù –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞")
            return
        
        print("\nüìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:")
        for i, item in enumerate(self.conversation_history, 1):
            print(f"\n{i}. –í–æ–ø—Ä–æ—Å: {item['question']}")
            print(f"   –û—Ç–≤–µ—Ç: {item['answer'][:100]}...")
            print(f"   –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {item['confidence']}")
    
    def _show_stats(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        stats = self.rag.get_stats()
        print("\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {stats['total_queries']}")
        print(f"   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {stats['total_tokens']}")
        print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {stats['avg_retrieval_score']:.3f}")
        print(f"   ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ: {len(self.rag.documents)}")


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ó–ê–ü–£–°–ö
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if __name__ == "__main__":
    bot = QABot(name="Python Helper")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
    sample_docs_path = Path(__file__).parent / "data" / "sample_docs.txt"
    
    if sample_docs_path.exists():
        bot.load_documents_from_file(str(sample_docs_path))
    else:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
        print("‚ö†Ô∏è –§–∞–π–ª sample_docs.txt –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä—ã...")
        docs = [
            "Python ‚Äî —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ 1991 –≥–æ–¥—É.",
            "–°–ø–∏—Å–∫–∏ –≤ Python —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏: [1, 2, 3].",
            "–°–ª–æ–≤–∞—Ä–∏ —Ö—Ä–∞–Ω—è—Ç –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ: {'name': 'Alice'}.",
        ]
        bot.rag.add_documents(docs, ["python.txt", "lists.txt", "dicts.txt"])
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
    bot.run_interactive()
```

## 4. –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```python
def retrieve_with_smart_filtering(
    self, 
    query: str, 
    top_k: int = 10,
    min_threshold: float = 0.5,
    max_gap: float = 0.2
) -> List[Dict]:
    """
    –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ë–µ—Ä—ë–º top_k —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    2. –û—Ç—Å–µ–∫–∞–µ–º –Ω–∏–∂–µ min_threshold
    3. –û—Ç—Å–µ–∫–∞–µ–º, –µ—Å–ª–∏ —Ä–∞–∑—Ä—ã–≤ —Å –ª—É—á—à–∏–º > max_gap
    """
    results = self.retrieve(query, top_k)
    
    if not results:
        return []
    
    best_score = results[0]["score"]
    
    filtered = []
    for r in results:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥
        if r["score"] < min_threshold:
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä—ã–≤ —Å –ª—É—á—à–∏–º
        if best_score - r["score"] > max_gap:
            continue
        
        filtered.append(r)
    
    return filtered
```

### –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM

```python
def rerank_with_llm(
    self,
    query: str,
    documents: List[Dict],
    top_k: int = 3
) -> List[Dict]:
    """
    –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é LLM.
    –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ, –Ω–æ –¥–æ—Ä–æ–∂–µ.
    """
    if len(documents) <= top_k:
        return documents
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
    docs_text = "\n\n".join([
        f"[{i+1}] {doc['text'][:300]}..."
        for i, doc in enumerate(documents)
    ])
    
    prompt = f"""–û—Ü–µ–Ω–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å.
    
–í–æ–ø—Ä–æ—Å: {query}

–î–æ–∫—É–º–µ–Ω—Ç—ã:
{docs_text}

–í–µ—Ä–Ω–∏ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (–æ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –∫ –Ω–∞–∏–º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–º—É).
–§–æ—Ä–º–∞—Ç: 3, 1, 5, 2, 4"""
    
    response = self._call_llm(prompt)
    
    # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
    try:
        order = [int(x.strip()) - 1 for x in response.split(',')]
        reranked = [documents[i] for i in order if 0 <= i < len(documents)]
        return reranked[:top_k]
    except:
        # –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
        return documents[:top_k]
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞

```python
RAG_FALLBACK_PROMPT = """–¢—ã ‚Äî —á–µ—Å—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–∏,
–µ—Å—Ç—å –ª–∏ –≤ –Ω–∏—Ö –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å.

–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ï–°–¢–¨ ‚Äî –¥–∞–π –µ–≥–æ.
–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –ù–ï–¢ ‚Äî —Å–∫–∞–∂–∏: "–í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É."
–∏ –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç.

–ù–ï –í–´–î–£–ú–´–í–ê–ô –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –õ—É—á—à–µ —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å "–Ω–µ –∑–Ω–∞—é"."""


def query_with_fallback(self, question: str) -> RAGResult:
    """
    –ó–∞–ø—Ä–æ—Å —Å —è–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—Ç–≤–µ—Ç–∞.
    """
    retrieved = self.retrieve(question, top_k=5, threshold=0.3)
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    if not retrieved:
        return RAGResult(
            answer="–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É. "
                   "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—Ç—å –¥—Ä—É–≥–æ–π.",
            sources=[],
            confidence="–ù–ï–¢ –î–ê–ù–ù–´–•",
            tokens_used=0
        )
    
    # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –Ω–∏–∑–∫–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
    if retrieved[0]["score"] < 0.5:
        return RAGResult(
            answer=f"–ù–∞–π–¥–µ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –Ω–∏–∑–∫–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é ({retrieved[0]['score']:.2f}). "
                   f"–í–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–≤–µ—Ç –Ω–µ—Ç–æ—á–µ–Ω –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.",
            sources=retrieved,
            confidence="–ù–ò–ó–ö–ê–Ø",
            tokens_used=0
        )
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å fallback –ø—Ä–æ–º–ø—Ç–æ–º
    answer, tokens = self._generate_answer(question, retrieved, RAG_FALLBACK_PROMPT)
    
    return RAGResult(
        answer=answer,
        sources=retrieved,
        confidence=self._assess_confidence(retrieved),
        tokens_used=tokens
    )
```

## 5. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ RAG

### –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

```python
"""
–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ RAG-—Å–∏—Å—Ç–µ–º—ã.
"""

from typing import List, Dict
from dataclasses import dataclass


@dataclass
class EvaluationResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ü–µ–Ω–∫–∏"""
    question: str
    expected_answer: str
    actual_answer: str
    retrieval_precision: float  # –î–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å—Ä–µ–¥–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
    answer_relevance: float     # –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –≤–æ–ø—Ä–æ—Å—É
    faithfulness: float         # –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º


class RAGEvaluator:
    """
    –û—Ü–µ–Ω—â–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ RAG-—Å–∏—Å—Ç–µ–º—ã.
    """
    
    def __init__(self, rag_pipeline, judge_model: str = "openai/gpt-4"):
        self.rag = rag_pipeline
        self.judge_model = judge_model
    
    def evaluate_retrieval(
        self,
        question: str,
        expected_doc_ids: List[int],
        retrieved_docs: List[Dict]
    ) -> float:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ retrieval.
        
        Returns:
            Precision@K: –¥–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å—Ä–µ–¥–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
        """
        retrieved_ids = [d["metadata"].get("doc_id", i) for i, d in enumerate(retrieved_docs)]
        relevant = sum(1 for rid in retrieved_ids if rid in expected_doc_ids)
        
        return relevant / len(retrieved_docs) if retrieved_docs else 0.0
    
    def evaluate_answer_relevance(
        self,
        question: str,
        answer: str
    ) -> float:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –≤–æ–ø—Ä–æ—Å—É —Å –ø–æ–º–æ—â—å—é LLM-as-judge.
        
        Returns:
            Score –æ—Ç 0 –¥–æ 1
        """
        prompt = f"""–û—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –≤–æ–ø—Ä–æ—Å—É.

–í–æ–ø—Ä–æ—Å: {question}
–û—Ç–≤–µ—Ç: {answer}

–û—Ü–µ–Ω–∫–∞ –æ—Ç 0 –¥–æ 10, –≥–¥–µ:
10 = –∏–¥–µ–∞–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
5 = —á–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç
0 = —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–µ –ø–æ —Ç–µ–º–µ

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ."""
        
        try:
            response = self._call_judge(prompt)
            score = float(response.strip()) / 10
            return min(max(score, 0), 1)
        except:
            return 0.5
    
    def evaluate_faithfulness(
        self,
        answer: str,
        source_docs: List[str]
    ) -> float:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏.
        
        Returns:
            Score –æ—Ç 0 –¥–æ 1
        """
        sources_text = "\n\n".join([f"[{i+1}] {doc}" for i, doc in enumerate(source_docs)])
        
        prompt = f"""–û—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –¢–û–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.
–ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äî –µ—Å—Ç—å –ª–∏ –æ–Ω–æ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö?

–ò—Å—Ç–æ—á–Ω–∏–∫–∏:
{sources_text}

–û—Ç–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
{answer}

–û—Ü–µ–Ω–∫–∞ –æ—Ç 0 –¥–æ 10:
10 = –≤—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
5 = —á–∞—Å—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
0 = –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—ã–¥—É–º–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ."""
        
        try:
            response = self._call_judge(prompt)
            score = float(response.strip()) / 10
            return min(max(score, 0), 1)
        except:
            return 0.5
    
    def run_evaluation(
        self,
        test_cases: List[Dict]
    ) -> List[EvaluationResult]:
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é –æ—Ü–µ–Ω–∫—É –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö.
        
        Args:
            test_cases: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª—è–º–∏:
                - question: –≤–æ–ø—Ä–æ—Å
                - expected_answer: –æ–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç
                - relevant_docs: —Å–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        """
        results = []
        
        for case in test_cases:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            rag_result = self.rag.query(case["question"])
            
            # –û—Ü–µ–Ω–∏–≤–∞–µ–º retrieval
            retrieval_precision = self.evaluate_retrieval(
                case["question"],
                case.get("relevant_docs", []),
                rag_result.sources
            )
            
            # –û—Ü–µ–Ω–∏–≤–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            answer_relevance = self.evaluate_answer_relevance(
                case["question"],
                rag_result.answer
            )
            
            # –û—Ü–µ–Ω–∏–≤–∞–µ–º faithfulness
            source_texts = [s["text"] for s in rag_result.sources]
            faithfulness = self.evaluate_faithfulness(
                rag_result.answer,
                source_texts
            )
            
            results.append(EvaluationResult(
                question=case["question"],
                expected_answer=case.get("expected_answer", ""),
                actual_answer=rag_result.answer,
                retrieval_precision=retrieval_precision,
                answer_relevance=answer_relevance,
                faithfulness=faithfulness
            ))
        
        return results
    
    def print_report(self, results: List[EvaluationResult]):
        """–í—ã–≤–æ–¥–∏—Ç –æ—Ç—á—ë—Ç –æ–± –æ—Ü–µ–Ω–∫–µ"""
        print("\n" + "="*70)
        print("–û–¢–ß–Å–¢ –û–ë –û–¶–ï–ù–ö–ï RAG")
        print("="*70)
        
        # –°—Ä–µ–¥–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
        avg_retrieval = sum(r.retrieval_precision for r in results) / len(results)
        avg_relevance = sum(r.answer_relevance for r in results) / len(results)
        avg_faithfulness = sum(r.faithfulness for r in results) / len(results)
        
        print(f"\nüìä –û–ë–©–ò–ï –ú–ï–¢–†–ò–ö–ò ({len(results)} —Ç–µ—Å—Ç–æ–≤):")
        print(f"   ‚Ä¢ Retrieval Precision: {avg_retrieval:.2%}")
        print(f"   ‚Ä¢ Answer Relevance:    {avg_relevance:.2%}")
        print(f"   ‚Ä¢ Faithfulness:        {avg_faithfulness:.2%}")
        
        # –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É
        print(f"\nüìù –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø:")
        for i, r in enumerate(results, 1):
            print(f"\n{i}. {r.question[:50]}...")
            print(f"   Retrieval: {r.retrieval_precision:.2%} | "
                  f"Relevance: {r.answer_relevance:.2%} | "
                  f"Faithfulness: {r.faithfulness:.2%}")
    
    def _call_judge(self, prompt: str) -> str:
        """–í—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å-—Å—É–¥—å—é"""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ API —á—Ç–æ –∏ –≤ RAG
        import requests
        import os
        
        response = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}",
                "Content-Type": "application/json"
            },
            json={
                "model": self.judge_model,
                "messages": [{"role": "user", "content": prompt}],
                "max_tokens": 50,
                "temperature": 0
            }
        )
        
        return response.json()["choices"][0]["message"]["content"]
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è

### üü¢ –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å

**–ó–∞–¥–∞–Ω–∏–µ 1: –°–æ–∑–¥–∞–Ω–∏–µ RAG pipeline**

1. –ò—Å–ø–æ–ª—å–∑—É—è –∫–æ–¥ –∏–∑ —É—Ä–æ–∫–∞, —Å–æ–∑–¥–∞–π—Ç–µ RAG pipeline
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ `sample_docs.txt`
3. –ó–∞–¥–∞–π—Ç–µ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã
4. –ó–∞–ø–∏—à–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü—É:

| –í–æ–ø—Ä–æ—Å | –û—Ç–≤–µ—Ç | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å | –ò—Å—Ç–æ—á–Ω–∏–∫–∏ |
|--------|-------|-------------|-----------|
| ... | ... | ... | ... |

**–ó–∞–¥–∞–Ω–∏–µ 2: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏**

1. –°–æ–∑–¥–∞–π—Ç–µ 3 —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è RAG
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö
3. –°—Ä–∞–≤–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤

### üü° –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å

**–ó–∞–¥–∞–Ω–∏–µ 3: QA-–±–æ—Ç –ø–æ —Å–≤–æ–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º**

1. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ 10+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–π —Ç–µ–º–µ
2. –°–æ–∑–¥–∞–π—Ç–µ QA-–±–æ—Ç–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ 10 –≤–æ–ø—Ä–æ—Å–∞—Ö
4. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–ª—É—á–∞–∏

**–ó–∞–¥–∞–Ω–∏–µ 4: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞**

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–∞–±–æ—Ä –∏–∑ 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ RAGEvaluator
3. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
4. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è

### üî¥ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å

**–ó–∞–¥–∞–Ω–∏–µ 5: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è QA-–±–æ—Ç–∞**

–°–æ–∑–¥–∞–π—Ç–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Flask/FastAPI:
1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç —Å RAG
3. –ü–æ–∫–∞–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞—Å—Ç–µ–π
4. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤

**–ó–∞–¥–∞–Ω–∏–µ 6: Feedback loop**

–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç (üëç/üëé)
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ –≤ –ë–î
3. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
4. –û—Ç—á—ë—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

1. **–ö–∞–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—Ö–æ–¥—è—Ç –≤ RAG pipeline?**
   <details>
   <summary>–û—Ç–≤–µ—Ç</summary>
   1. Chunking ‚Äî —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
   2. Embedding ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –≤–µ–∫—Ç–æ—Ä—ã
   3. Vector DB ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤
   4. Retrieval ‚Äî –ø–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   5. Generation ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   </details>

2. **–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–º–ø—Ç –¥–ª—è RAG?**
   <details>
   <summary>–û—Ç–≤–µ—Ç</summary>
   –ü—Ä–æ–º–ø—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä—ë—Ö —á–∞—Å—Ç–µ–π: 1) —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, 2) –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏, 3) –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–∞–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
   </details>

3. **–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?**
   <details>
   <summary>–û—Ç–≤–µ—Ç</summary>
   –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: 1) –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º –æ–∫–Ω–µ, 2) –º–æ–≥—É—Ç –≤–≤–µ—Å—Ç–∏ –º–æ–¥–µ–ª—å –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ, 3) —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å (–±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤), 4) —Å–Ω–∏–∂–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞.
   </details>

4. **–ß—Ç–æ —Ç–∞–∫–æ–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ?**
   <details>
   <summary>–û—Ç–≤–µ—Ç</summary>
   –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø –ø–æ—Å–ª–µ retrieval, –≥–¥–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º –º–µ—Ç–æ–¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é LLM –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏). –ü–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.
   </details>

5. **–ö–∞–∫ –æ—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ RAG-—Å–∏—Å—Ç–µ–º—ã?**
   <details>
   <summary>–û—Ç–≤–µ—Ç</summary>
   –¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: 1) Retrieval Precision ‚Äî –¥–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å—Ä–µ–¥–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö, 2) Answer Relevance ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–æ–ø—Ä–æ—Å—É, 3) Faithfulness ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö (–±–µ–∑ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π).
   </details>

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —É—Ä–æ–∫–∞

### –ß—Ç–æ –º—ã –∏–∑—É—á–∏–ª–∏

- **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤**: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã RAG-–ø—Ä–æ–º–ø—Ç–æ–≤
- **RAG Pipeline**: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **QA-–±–æ—Ç**: —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞
- **–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞**: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ, fallback
- **–û—Ü–µ–Ω–∫–∞**: –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–µ—Ç–æ–¥—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —É—Ä–æ–∫–∞–º–∏

- **–£—Ä–æ–∫ 1**: –¢–µ–ø–µ—Ä—å –ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫ RAG —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ
- **–£—Ä–æ–∫ 2**: Retriever –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Generator
- **–ú–æ–¥—É–ª—å 2**: LLM-as-a-judge –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –ß—Ç–æ –¥–∞–ª—å—à–µ

–í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ **"–£–ª—É—á—à–µ–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ RAG"** –º—ã –∏–∑—É—á–∏–º:
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–µ–º–∞–Ω—Ç–∏–∫–∞ + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ chunking
- Query transformation (HyDE, multi-query)
- Production considerations

### –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å

üéØ **–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!** –í—ã —Å–æ–∑–¥–∞–ª–∏:
- ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π RAG pipeline
- ‚úÖ –†–∞–±–æ—Ç–∞—é—â–µ–≥–æ QA-–±–æ—Ç–∞
- ‚úÖ –°–∏—Å—Ç–µ–º—É –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**–ì–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º —Ç–µ—Ö–Ω–∏–∫–∞–º?** –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ [–£—Ä–æ–∫—É 4: –£–ª—É—á—à–µ–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ RAG](lesson_4_advanced_rag.md)!

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –°—Ç–∞—Ç—å–∏:
- [RAGAS: Automated Evaluation of Retrieval Augmented Generation](https://arxiv.org/abs/2309.15217)
- [Lost in the Middle: How Language Models Use Long Contexts](https://arxiv.org/abs/2307.03172)

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- [LangChain RAG](https://python.langchain.com/docs/use_cases/question_answering/)
- [LlamaIndex Query Engines](https://docs.llamaindex.ai/en/stable/understanding/querying/)
- [RAGAS](https://github.com/explodinggradients/ragas) ‚Äî —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ RAG

